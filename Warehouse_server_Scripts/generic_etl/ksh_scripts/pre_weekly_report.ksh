#!/bin/bash

set +x
export pth=`date +%d%b%y`
cd /home/dwhuser/generic_etl/wip
perl -pi -e 's/,,/,\\N,/g' ALL_Weekely_REP*
echo "select @rownum := @rownum + 1 AS rownum,Client_Name,Account_Id,Vertical_Id,Industry,Admin_Login_Id,Acc_User_DB_access,Last_activation_date,Last_expiry_date,Online_products_active,logins_per_day_in_last_week,logins_per_day_in_last_month,Active_Jobs,New_Jobs_posted_in_last_week,New_Jobs_posted_in_last_month,Total_Expired_Jobs,Jobs_expired_in_last_week,Jobs_expired_in_last_month,searches_per_day_in_last_week,searches_per_day_in_last_month,resume_views_per_day_in_last_week,resume_views_per_day_in_last_month,Excel_Download_Last_Week,Excel_Download_Last_Month,pd_Db_Service,pd_db_Expiry_Date,pd_db_Start_Date,pd_job_Service,pd_job_Expiry_Date,pd_job_Start_Date,pd_visible_Service,pd_visible_Expiry_Date,pd_visible_Start_Date,pd_oth_Service,pd_oth_Expiry_Date,pd_oth_Start_Date,pd_flag,tr_Db_Service,tr_db_Expiry_Date,tr_db_Start_Date,tr_job_Service,tr_job_Expiry_Date,tr_job_Start_Date,tr_visible_Service,tr_visible_Expiry_Date,tr_visible_Start_Date,tr_oth_Service,tr_oth_Expiry_Date,tr_oth_Start_Date,tr_flag,Location,Contact_Person,Designation,'' as Contact_Landline,'' as Contact_Mobile,case when  substr(Client_Email_Id,locate('@',Client_Email_Id) +1) = 'timesgroup.com' then 'TJ' else 'NON TJ' end as Client_Email_Id,Sales_Person_Email_ID,ZM_Email_ID,col1,col2,col3,col4,col5,col6,col7,col8,col9,col10,col11,col12,col13,col14,col15,col16,col17,col18,col19,col20,col21,col22,col23,col24,col25,col26 from weekly_report_fact,(SELECT @rownum:=0) AS foo where create_date=date(now()) INTO OUTFILE '/tmp/weeklyReport${pth}.csv' FIELDS TERMINATED BY ',' ENCLOSED BY '\"' LINES TERMINATED BY '\\n';" > /home/dwhuser/generic_etl/sql_scripts/weekly_report.sql
exit
