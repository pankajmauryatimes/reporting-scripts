#!/bin/bash

export pth=`date +%d%b%y`

echo "select  ld.admin_login_id, AAA.title, AAA.fa_desc, AAA.industry_desc, AAA.location_name, AAA.min_exp, AAA.max_exp, AAA.min_sal, AAA.max_sal, count(distinct AAA.Ad_id)  from ( select    max(TT.login_key) as login_key, max(TT.Title) as title, TT.ad_id as ad_id, max(TT.fa_desc) as fa_desc, max(TT.industry_desc) as industry_desc, max(TT.location_name) as location_name, sum(min_exp) as min_exp, sum(max_exp) as max_exp, sum(min_sal) as min_sal, sum(max_sal) as max_sal from (select 0 as login_key, ''  as title,T.ad_id,group_concat(fd.functional_area_desc order by fd.functional_area_desc ) as fa_desc, '' as industry_desc, '' as location_name, 0 as min_exp, 0 as max_exp, 0 as min_sal, 0 as max_sal from ( select jf.ad_id,jf.function_key from job_fact jf, job_dimension jd where jf.job_key = jd.job_key and jd.status_flag = 11 group by jf.ad_id,jf.function_key order by jf.function_key asc )T,functionalarea_dimension fd where fd.fa_key = T.function_key Group by T.ad_id UNION select 0 as login_key, ''  as title,T.ad_id, '' as fa_desc, group_concat(id.industry_desc order by id.industry_desc) as industry_desc, '' as location_name, 0 as min_exp, 0 as max_exp, 0 as min_sal, 0 as max_sal from( select jf.ad_id,jf.industry_key from job_dimension jd, job_fact jf where jf.job_key = jd.job_key and jd.status_flag = 11 Group by jf.ad_id,jf.industry_key order by jf.industry_key )T, industry_dimension id where T.industry_key = id.industry_key Group by T.ad_id UNION select 0 as login_key, ''  as title,T.ad_id, '' as fa_desc, '' as industry_desc, group_concat(id.location_name order by id.location_name) as location_name,0 as min_exp, 0 as max_exp, 0 as min_sal, 0 as max_sal from( select jf.ad_id,jf.location_key from job_dimension jd, job_fact jf where jf.job_key = jd.job_key and jd.status_flag = 11 Group by jf.ad_id,jf.location_key order by jf.location_key )T, location_dimension id where T.location_key = id.location_key Group by T.ad_id UNION select jd.login_key,jd.title,jd.ad_id,'' as fa_desc, '' as industry_desc, '' as location_name, jd.min_exp, jd.max_exp, jd.min_sal, jd.max_sal from job_dimension jd where jd.status_flag = 11 Group by jd.ad_id  ) TT Group by TT.ad_id  ) AAA, login_dimension ld where ld.login_key = AAA.login_key GROUP BY ld.admin_login_id, AAA.title, AAA.fa_desc, AAA.industry_desc, AAA.location_name, AAA.min_exp, AAA.max_exp, AAA.min_sal, AAA.max_sal  having count(distinct AAA.ad_id) > 1 INTO OUTFILE '/tmp/Amitabh_Duplicate_jobs-${pth}.csv' FIELDS TERMINATED BY ',' ENCLOSED BY '\"' LINES TERMINATED BY '\n';" >  /home/dwhuser/generic_etl/sql_scripts/job_duplicate.sql

